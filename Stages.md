# Pipeline stages
BBPower is made up of the following stages:

## 1. BBPowerSpecter
### Stage summary
BBPowerSpecter takes a set of maps (with their masks and other metadata), and computes all possible power spectra, cross-correlating different data splits, frequency channels and polarization channels. It does that for the data and for a number of simulations.

### Inputs
- `splits_list`: a txt file containing a list of file paths. Each file should be a fits file containing 2 maps (Q and U) per frequency channel. Each file should correspond to one data split (i.e. a map made from only part of the data).
- `masks_apodized`: a fits file containing one map per frequency channel. Each map should be the apodized mask to be used on all maps corresponding to that frequency channel.
- `bandpasses_list`: a txt file containing a list of file paths. Each file should be a txt file containing the bandpass for one of the frequency channels (in the same order in which the maps are stored in the files above). Two columns: frequency and transmission.
- `sims_list`: a txt file containing a list of paths. Each path should lead to a directory containing a sky simulation. The simulation maps should be structured in the same way as the data splits contained in `splits_list`.
- `beams_list`: a txt file containing a list of file paths. Each file should be a txt file containing the beam for one of the frequency channels (in the same order in which the maps are stored in the files above). Two columns: multipole ell and beam_ell.

### Outputs
- `cells_all_splits`: a fits file containing all possible auto- and cross-spectra between all different data splits, frequency channels and polarization components (E and B). The files are in [SACC](https://github.com/LSSTDESC/sacc) format, and contain also the bandpass and beam information, as well as all the bandpower window functions.
- `cells_all_sims`: a txt file containing a list of files. Each file is the fits file containing the power spectra for a given simulation, in the same format as `cells_all_splits`.

### Parameters
- `bpw_edges`: a txt file containing a list of integers defining the edges of the bandpowers.
- `purify_B`: set to True if you want to use B-mode purification.
- `n_iter`: iter parameter for spherical harmonic transforms.


## 2. BBPowerSummarizer
### Stage summary
BBPowerSummarizer takes all the cross-split spectra generated by BBPowerSpecter for data and sims and calculates the total coadded spectra, coadded spectra using only pairs of different splits, the noise power spectra, and all null power spectra. It does so for the data and all sims. The sims spectra are then used to compute the covariance matrix of the data spectra.

### Inputs
- `splits_list`: see BBPowerSpecter inputs.
- `bandpasses_list`: see BBPowerSpecter inputs.
- `cells_all_splits`: see BBPowerSpecter outputs.
- `cells_all_sims`: see BBPowerSpecter outputs.

### Outputs
- `cells_coadded`: a fits file containing all cross-frequency and cross-polarization power spectra coadded over pairs of different data splits (i.e. these spectra should not have any noise contribution). The files will be in [SACC](https://github.com/LSSTDESC/sacc) format, and will contain also the covariance as well as all bandpasses, beams and bandpower window functions.
- `cells_coadded_total`: same as `cells_coadded`, except this file will contain the spectra computed by coadding over all pairs of splits (including auto-correlations). These will have a noise bias.
- `cells_noise`: this will contain the noise power spectra (in the same format as `cells_coadded`), calculated as the difference between `cells_coadded_total` and `cells_coadded`.
- `cells_null`: this will contain all combinations of cross-split/frequency/polarization power spectra that should be compatible with zero. Also in SACC format.

### Options
- `nulls_covar_type`: type of covariance matrix for null spectra. Choose `diagonal`, `block_diagonal` or `dense`.
- `nulls_covar_diag_order`: number of secondary diagonals to store if the previous option is `diagonal` or `block_diagonal`.
- `data_covar_type`: same as `nulls_covar_type` for the coadded data files.
- `data_covar_diag_order`: same as `nulls_covar_diag_order` for the coadded data files.


## 3. BBCompSep
### Stage summary
This stage takes a set of coadded multi-frequency polarization power spectra and evaluates their likelihood with respect to a multi-frequency CMB+foreground model. In its standard form, it will run an MCMC of the likelihood and store the parameter chains. It can also be used to calculate Fisher matrices, minimize the likelihood or simply evaluate it at a single point. We only document the standard form here.

### Inputs
- `cells_coadded`: see BBPowerSummarizer outputs.
- `cells_noise`: see BBPowerSummarizer outputs
- `cells_fiducial`: a fits file containing multi-frequency and multi-polarization power spectra for a model that should roughly resemble the data (e.g. the model used to generate the simulations in the previous stages). This is only needed if you're using the Hamimeche & Lewis likelihood.

### Output
- `output_dir`: a directory containing the parameter MCMC chain.

### Parameters
See [test/test_config_sampling.yml](test/test_config_sampling.yml)

## 4. BBPlotter
### Stage summary
This stage generates a webpage containing a set of plots illustrating the main pipeline results.

### Inputs
- `cells_coadded_total`: see BBPowerSummarizer output.
- `cells_coadded`: see BBPowerSummarizer output.
- `cells_noise`: see BBPowerSummarizer output.
- `cells_null`: see BBPowerSummarizer output.
- `cells_fiducial`: see BBCompSep input.
- `param_chains`: see BBCompSep output.

### Outputs
- `plots`: a directory containing all the output plots as png files.
- `plots_page`: an HTML file containing links to all of those plots.

### Parameters
See [test/test_config_sampling.yml](test/test_config_sampling.yml)

## 5. BBEllwise
### Stage summary
This stage saves the CMB bandpowers inferred by the ellwise sampler, implemented in BBCompSep. It optionally validates the results by re-inserting the bandpowers in a CMB-only likelihood, inferring r and A_lens, and comparing those results with r and A_lens inferred by the default pipeline.

### Inputs
- `default_chain`: either a `npz`, or a `stats` file containing the output from the default (non-ellwise) sampler.

### Outputs
- `output_dir`: a directory containing the input (!) and output chains, as well as the resulting bandpowers from the ellwise CMB sampler.

### Parameters
See [test/test_config_ellwise.yml](test/test_config_ellwise.yml)
